name: Model Management and LFS

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'upload'
        options:
          - upload
          - download
          - verify
      model_version:
        description: 'Model version (e.g., v1.0.0)'
        required: false
        type: string
        default: 'v1.0.0'
  push:
    branches:
      - main
      - master
    paths:
      - 'model/**'

permissions:
  contents: write
  packages: write

env:
  MODEL_PATH: model/finetuned_best_model.pth
  MODEL_NAME: finetuned_best_model.pth

jobs:
  # ===========================================================================
  # Upload Model to GitHub Releases
  # ===========================================================================
  upload-model:
    if: inputs.action == 'upload' || github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: |
          git lfs pull
          echo "=== LFS Files Status ==="
          git lfs ls-files -s
          echo ""

      - name: Verify model file exists
        id: verify
        run: |
          if [ -f "${{ env.MODEL_PATH }}" ]; then
            echo "✓ Model file found"
            SIZE=$(du -h ${{ env.MODEL_PATH }} | cut -f1)
            SIZE_BYTES=$(stat -c%s ${{ env.MODEL_PATH }})
            CHECKSUM=$(sha256sum ${{ env.MODEL_PATH }} | cut -d' ' -f1)
            
            echo "Path: ${{ env.MODEL_PATH }}"
            echo "Size: $SIZE ($SIZE_BYTES bytes)"
            echo "SHA256: $CHECKSUM"
            
            echo "size=$SIZE" >> $GITHUB_OUTPUT
            echo "size_bytes=$SIZE_BYTES" >> $GITHUB_OUTPUT
            echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          else
            echo "❌ ERROR: Model file not found at ${{ env.MODEL_PATH }}"
            ls -la model/ || echo "model/ directory does not exist"
            exit 1
          fi

      - name: Create or update release
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="model-${{ inputs.model_version || 'v1.0.0' }}"
          RELEASE_NAME="Model ${{ inputs.model_version || 'v1.0.0' }}"
          
          BODY="## Model Release
          
          **File:** ${{ env.MODEL_NAME }}
          **Size:** ${{ steps.verify.outputs.size }}
          **SHA256:** \`${{ steps.verify.outputs.checksum }}\`
          
          This model is stored in Git LFS and can be downloaded directly from this release."
          
          echo "=== Checking for existing release: $TAG_NAME ==="
          
          RELEASE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME")
          
          if echo "$RELEASE_DATA" | grep -q '"id"'; then
            RELEASE_ID=$(echo "$RELEASE_DATA" | jq -r '.id')
            echo "Found existing release ID: $RELEASE_ID"
            
            echo "Deleting existing assets..."
            ASSETS=$(echo "$RELEASE_DATA" | jq -r '.assets[] | .id')
            for ASSET_ID in $ASSETS; do
              curl -s -X DELETE \
                -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/${{ github.repository }}/releases/assets/$ASSET_ID"
              echo "Deleted asset: $ASSET_ID"
            done
          else
            echo "Creating new release: $TAG_NAME"
            
            RELEASE_RESPONSE=$(curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"tag_name\":\"$TAG_NAME\",\"name\":\"$RELEASE_NAME\",\"body\":$(echo "$BODY" | jq -R -s .),\"draft\":false,\"prerelease\":false}" \
              "https://api.github.com/repos/${{ github.repository }}/releases")
            
            RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id')
            echo "Created release ID: $RELEASE_ID"
          fi
          
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Upload model asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_ID="${{ steps.create_release.outputs.release_id }}"
          UPLOAD_URL="https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets"
          
          echo "=== Uploading model to release ==="
          echo "Release ID: $RELEASE_ID"
          echo "File: ${{ env.MODEL_PATH }}"
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"${{ env.MODEL_PATH }}" \
            "$UPLOAD_URL?name=${{ env.MODEL_NAME }}&label=Model%20File" \
            -o upload_response.json
          
          cat upload_response.json | jq .
          
          if cat upload_response.json | jq -e '.id' > /dev/null; then
            echo "✓ Model uploaded successfully"
          else
            echo "❌ Upload failed"
            exit 1
          fi

  # ===========================================================================
  # Download Model from GitHub Releases
  # ===========================================================================
  download-model:
    if: inputs.action == 'download'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release information
        id: get_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "${{ inputs.model_version }}" ] && [ "${{ inputs.model_version }}" != "latest" ]; then
            TAG_NAME="model-${{ inputs.model_version }}"
            echo "Fetching specific release: $TAG_NAME"
            RELEASE_URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME"
          else
            echo "Fetching latest model release"
            RELEASE_URL="https://api.github.com/repos/${{ github.repository }}/releases/latest"
          fi
          
          RELEASE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$RELEASE_URL")
          
          if echo "$RELEASE_DATA" | grep -q '"message"'; then
            ERROR_MSG=$(echo "$RELEASE_DATA" | jq -r '.message')
            echo "❌ Error: $ERROR_MSG"
            exit 1
          fi
          
          ASSET_ID=$(echo "$RELEASE_DATA" | jq -r ".assets[] | select(.name==\"${{ env.MODEL_NAME }}\") | .id")
          ASSET_URL=$(echo "$RELEASE_DATA" | jq -r ".assets[] | select(.name==\"${{ env.MODEL_NAME }}\") | .url")
          
          if [ -z "$ASSET_ID" ] || [ "$ASSET_ID" == "null" ]; then
            echo "❌ Model asset not found in release"
            exit 1
          fi
          
          echo "asset_id=$ASSET_ID" >> $GITHUB_OUTPUT
          echo "asset_url=$ASSET_URL" >> $GITHUB_OUTPUT

      - name: Download model
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p model
          
          echo "=== Downloading model ==="
          echo "Asset ID: ${{ steps.get_release.outputs.asset_id }}"
          
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "${{ steps.get_release.outputs.asset_url }}" \
            -o "${{ env.MODEL_PATH }}"
          
          if [ -f "${{ env.MODEL_PATH }}" ]; then
            echo "✓ Model downloaded successfully"
            ls -lh "${{ env.MODEL_PATH }}"
            sha256sum "${{ env.MODEL_PATH }}"
          else
            echo "❌ Download failed"
            exit 1
          fi

      - name: Upload as artifact
        uses: actions/upload-artifact@v4
        with:
          name: model-artifact
          path: ${{ env.MODEL_PATH }}
          retention-days: 7

  # ===========================================================================
  # Verify Model Integrity
  # ===========================================================================
  verify-model:
    if: inputs.action == 'verify' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Verify model file
        run: |
          echo "=== Model Verification ==="
          
          if [ ! -f "${{ env.MODEL_PATH }}" ]; then
            echo "❌ Model file not found"
            exit 1
          fi
          
          SIZE=$(du -h ${{ env.MODEL_PATH }} | cut -f1)
          SIZE_BYTES=$(stat -c%s ${{ env.MODEL_PATH }})
          CHECKSUM=$(sha256sum ${{ env.MODEL_PATH }} | cut -d' ' -f1)
          
          echo "✓ Model file exists"
          echo "Path: ${{ env.MODEL_PATH }}"
          echo "Size: $SIZE ($SIZE_BYTES bytes)"
          echo "SHA256: $CHECKSUM"

      - name: Check LFS pointer
        run: |
          echo "=== LFS Status ==="
          
          if git lfs ls-files | grep -q "${{ env.MODEL_NAME }}"; then
            echo "✓ Model is tracked by LFS"
            git lfs ls-files -s | grep "${{ env.MODEL_NAME }}"
          else
            echo "⚠ WARNING: Model is not tracked by LFS"
          fi

      - name: Validate model can be loaded
        run: |
          echo "=== Model Load Test ==="
          
          python3 << 'EOF'
          import os
          import sys
          
          try:
              import torch
              model_path = "${{ env.MODEL_PATH }}"
              
              if not os.path.exists(model_path):
                  print(f"❌ Model file not found: {model_path}")
                  sys.exit(1)
              
              print(f"Loading model from: {model_path}")
              checkpoint = torch.load(model_path, map_location='cpu')
              
              print("✓ Model loaded successfully")
              print(f"Keys in checkpoint: {list(checkpoint.keys())}")
              
              if 'model_state_dict' in checkpoint:
                  print(f"Model state dict keys: {len(checkpoint['model_state_dict'].keys())}")
              
          except Exception as e:
              print(f"❌ Error loading model: {e}")
              sys.exit(1)
          EOF

  # ===========================================================================
  # Build Docker with Model
  # ===========================================================================
  build-with-model:
    if: github.event_name == 'push' && contains(github.event.head_commit.modified, 'model/')
    runs-on: ubuntu-latest
    needs: verify-model
    permissions:
      packages: write
    steps:
      - name: Checkout code with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: |
          git lfs pull
          ls -lh ${{ env.MODEL_PATH }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend with new model
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/backend:latest
            ghcr.io/${{ github.repository }}/backend:model-update-${{ github.sha }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend
          platforms: linux/amd64
