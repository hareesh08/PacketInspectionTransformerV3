# ============================================================================
# Packet Inspection Transformer - Production Docker Compose
# ============================================================================
# Usage:
#   Production: docker compose --profile prod up -d
#   Development: docker compose --profile dev up -d
#   All services: docker compose up -d
# ============================================================================

services:
  # ----------------------------------------------------------------------------
  # Backend API Service (Production)
  # ----------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: packet-inspection-backend
    restart: unless-stopped
    profiles: [prod]
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - ./model:/app/model:ro
      - ./logs:/app/logs
    environment:
      - PYTHONPATH=/app
      - HOST=0.0.0.0
      - PORT=8000
      - MALWARE_DETECTOR_DEBUG=false
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - app-network

  # ----------------------------------------------------------------------------
  # Frontend Service (Production)
  # ----------------------------------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: Frontend/Dockerfile
    container_name: packet-inspection-frontend
    restart: unless-stopped
    profiles: [prod]
    ports:
      - "${WEB_PORT:-80}:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network

  # ----------------------------------------------------------------------------
  # Development Service (Hot Reload)
  # ----------------------------------------------------------------------------
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: packet-inspection-dev
    restart: unless-stopped
    profiles: [dev]
    ports:
      - "${DEV_PORT:-8001}:8000"
    volumes:
      - .:/app
      - ./model:/app/model:ro
      - ./logs:/app/logs
    environment:
      - PYTHONPATH=/app
      - HOST=0.0.0.0
      - PORT=8000
      - MALWARE_DETECTOR_DEBUG=true
      - DEBUG=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - app-network

networks:
  app-network:
    name: packet-inspection-network